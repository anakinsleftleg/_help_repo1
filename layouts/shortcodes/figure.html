<!-- get image path -->
{{ $imagePath := .Get "src" }}
{{ $inner := .Inner}}
<!-- image position -->
{{ $positionClass := "" }}
{{ with (index (intersect (slice "center" "left" "right" "float-left" "float-right") (slice (lower (.Get "position")))) 0) }}
  {{ $positionClass = add "img-" . }}
{{ end }}

<!-- check cdn image -->
{{ if or (hasPrefix $imagePath "http") (hasPrefix $imagePath "/") }}
  <!-- cdn image -->
  <!-- image figure -->
  {{ if .Get `title` }}
    <figure class="{{.Scratch.Get `image-position`}}">
      <img loading="lazy" decoding="async" src="{{ $imagePath | safeURL }}" alt="{{ .Get `alt` }}" class="{{.Get `c`}}" width="{{.Get `w`}}" height="{{.Get `h`}}">
      <figcaption>{{.Get `title` | markdownify}}</figcaption>
    </figure>
  {{ else }}
    <!-- image tag -->
    <img loading="lazy" decoding="async" src="{{ $imagePath | safeURL }}" alt="{{ .Get `alt` }}" class="{{.Get `c`}} {{.Scratch.Get `image-position`}}" width="{{.Get `w`}}" height="{{.Get `h`}}">
  {{ end }}
<!-- /image cdn -->

{{ else }}
  <!-- check image existence -->
  {{ $image := "" }}
  {{ if fileExists (add .Page.RelPermalink $imagePath) }}
    {{ $image = .Page.Resources.GetMatch $imagePath }}
  {{ else if fileExists (add `assets/` $imagePath) }}
    {{ $image = resources.Get $imagePath }}
  <!-- image from assets folder -->
  {{ else }}
    <strong class="text-danger mb-3 d-inline-block">{{.Page.Permalink}}{{$imagePath}} does not exist</strong>
  {{ end }}

  <!-- begin processing -->
  {{ $imagePostProcess := "" }}
  {{ $imageFallback := $image }}
  {{ if $image }}
    <!-- gif image -->
    {{ if eq $image.MediaType.SubType "gif" }}
    <!-- image processing -->
    {{ else }}
      {{ if (isset .Params "format") }}
        {{ $options := add (add (string (.Get "w" | default $image.Width)) "x ") (.Get "format") }}
        {{ $imagePostProcess = $image.Resize $options }}
      {{ end }}
      <!-- fallback image -->
      {{ $option := add (string (.Get "w" | default $image.Width)) "x" }}
      {{ $imageFallback = $image.Resize $option }}
    {{ end }}

    <!-- image figure -->
    <figure {{ with $positionClass }}class="{{ . }}"{{ end }}>
      <picture>
        {{ if $imagePostProcess }}
        <source 
          srcset="{{ $imagePostProcess.RelPermalink }}" 
          type="{{ $imagePostProcess.MediaType }}">
        {{ end }}
        <img 
        loading="lazy" 
        decoding="async" 
        {{ with (.Get "corners") }}class="{{ . }}"{{ end }}
        width="{{ $imageFallback.Width }}" 
        height="{{ $imageFallback.Height }}" 
        src="{{ $imageFallback.RelPermalink }}" 
        alt="{{.Get `alt`}}" 
        {{ with .Get "title" }}title="{{ . }}"{{ end }}>
      </picture>
        {{ if or (or (.Get "title") (.Get "caption")) (.Get "attribution") }}
        <figcaption>
          {{ with .Get "title" }}{{ . }}{{ end }}
          {{ if or (.Get "caption") (.Get "attribution") }}
            <p>
            {{ with .Get "caption" }}{{ . }}{{ end }}
            {{ with .Get "attribution" }}
            <br>
              {{ with $.Get "attrlink" }}<a href="{{ . }}">{{ end }}
              {{ . }}
              {{ with $.Get "attrlink" }}</a>{{ end }}
            {{ end }}
            </p>
          {{ end }}
        </figcaption>
        {{ end }}
    </figure>
  {{ end }}
{{ end }}
<!-- /check cdn image -->